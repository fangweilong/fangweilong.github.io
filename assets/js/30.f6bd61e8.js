(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{368:function(e,n,s){"use strict";s.r(n);var a=s(0),t=Object(a.a)({},(function(){var e=this,n=e._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("p",[n("strong",[e._v("在获取入参的时候，get方式的接口可以直接获取到，但是post形式的body获取以后会造成无法再使用，所以必须经过一层转换以后再读取。")])]),e._v(" "),n("p",[e._v("直接上代码")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('\n@Component\npublic class CacheBodyGatewayFilter implements GlobalFilter, Ordered {\n    public static final String CACHE_REQUEST_BODY_OBJECT_KEY = "cachedRequestBodyObject";\n\n    @Override\n    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        if (exchange.getRequest().getHeaders().getContentType() == null) {\n            return chain.filter(exchange);\n        } else {\n            return DataBufferUtils.join(exchange.getRequest().getBody())\n                    .flatMap(dataBuffer -> {\n                        DataBufferUtils.retain(dataBuffer);\n                        Flux<DataBuffer> cachedFlux = Flux\n                                .defer(() -> Flux.just(dataBuffer.slice(0, dataBuffer.readableByteCount())));\n                        ServerHttpRequest mutatedRequest = new ServerHttpRequestDecorator(\n                                exchange.getRequest()) {\n                            @Override\n                            public Flux<DataBuffer> getBody() {\n                                return cachedFlux;\n                            }\n\n                        };\n                        exchange.getAttributes().put(CACHE_REQUEST_BODY_OBJECT_KEY, cachedFlux);\n\n                        return chain.filter(exchange.mutate().request(mutatedRequest).build());\n                    });\n        }\n    }\n\n    @Override\n    public int getOrder() {\n    \t//这个代表了执行顺序，值越小越先执行 \n        return Ordered.HIGHEST_PRECEDENCE;\n    }\n}\n\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br")])]),n("p",[e._v("接下来是读取方法")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('\n@Component\npublic class AccessLogGlobalFilter implements GlobalFilter, Ordered {\n    public static final String CACHE_REQUEST_BODY_OBJECT_KEY = "cachedRequestBodyObject";\n\n\n    @Override\n    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        ServerHttpRequest request = exchange.getRequest();\n\n        //Record only http requests (including https)\n        String schema = request.getURI().getScheme();\n        if ((!"http".equals(schema) && !"https".equals(schema))) {\n            return chain.filter(exchange);\n        }\n\t\t//我自定义的实体类，如果不需要 你可以直接删掉\n        LogDTO logDTO = new LogDTO();\n        logDTO.setPath(request.getURI().getPath());\n        logDTO.setQueryParams(request.getQueryParams());\n        logDTO.setMethod(request.getMethod().name());\n        logDTO.setIp(request.getRemoteAddress().getHostName());\n        logDTO.setUserAgent(request.getHeaders().getFirst("User-Agent"));\n        exchange.getAttributes().put("startTime", System.currentTimeMillis());\n\n\n        //获取request body\n        Flux<DataBuffer> cachedBody = exchange.getAttribute(CACHE_REQUEST_BODY_OBJECT_KEY);\n        if(cachedBody!=null){\n            String raw = toRaw(cachedBody);\n            logDTO.setParams(raw);\n        }\n\n\n        return returnMono(chain, exchange, logDTO);\n    }\n\n    private Mono<Void> returnMono(GatewayFilterChain chain, ServerWebExchange exchange, LogDTO logDTO) {\n        return chain.filter(exchange).then(Mono.fromRunnable(() -> {\n            Long startTime = exchange.getAttribute("startTime");\n            if (startTime != null) {\n                long executeTime = (System.currentTimeMillis() - startTime);\n                logDTO.setTime(executeTime);\n                logDTO.setResultCode(Objects.requireNonNull(exchange.getResponse().getStatusCode()).value());\n                StaticLog.info("=================================");\n                StaticLog.info("请求方式：[{}]", logDTO.getMethod());\n                StaticLog.info("路径：[{}]", logDTO.getPath());\n                StaticLog.info("IP：[{}]", logDTO.getIp());\n                StaticLog.info("UserAgent：[{}]", logDTO.getUserAgent());\n                StaticLog.info("请求格式[{}]", exchange.getResponse().getHeaders().getContentType());\n                StaticLog.info("时长：[{}]", executeTime);\n                StaticLog.info("code：[{}]", logDTO.getResultCode());\n                StaticLog.info("body：[{}]", logDTO.getParams());\n            }\n        }));\n    }\n\n    @Override\n    public int getOrder() {\n    \t//这个filter的执行顺序要在 CacheBodyGatewayFilter 类之后 否则找不到缓存的值\n        return Ordered.HIGHEST_PRECEDENCE+1;\n    }\n\n    /**\n     * 用于获取请求参数\n     *\n     * @param body\n     * @return\n     */\n    private static String toRaw(Flux<DataBuffer> body) {\n        AtomicReference<String> rawRef = new AtomicReference<>();\n        body.subscribe(buffer -> {\n            byte[] bytes = new byte[buffer.readableByteCount()];\n            buffer.read(bytes);\n            DataBufferUtils.release(buffer);\n            rawRef.set(Strings.fromUTF8ByteArray(bytes));\n        });\n        return rawRef.get();\n    }\n\n}\n\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br"),n("span",{staticClass:"line-number"},[e._v("38")]),n("br"),n("span",{staticClass:"line-number"},[e._v("39")]),n("br"),n("span",{staticClass:"line-number"},[e._v("40")]),n("br"),n("span",{staticClass:"line-number"},[e._v("41")]),n("br"),n("span",{staticClass:"line-number"},[e._v("42")]),n("br"),n("span",{staticClass:"line-number"},[e._v("43")]),n("br"),n("span",{staticClass:"line-number"},[e._v("44")]),n("br"),n("span",{staticClass:"line-number"},[e._v("45")]),n("br"),n("span",{staticClass:"line-number"},[e._v("46")]),n("br"),n("span",{staticClass:"line-number"},[e._v("47")]),n("br"),n("span",{staticClass:"line-number"},[e._v("48")]),n("br"),n("span",{staticClass:"line-number"},[e._v("49")]),n("br"),n("span",{staticClass:"line-number"},[e._v("50")]),n("br"),n("span",{staticClass:"line-number"},[e._v("51")]),n("br"),n("span",{staticClass:"line-number"},[e._v("52")]),n("br"),n("span",{staticClass:"line-number"},[e._v("53")]),n("br"),n("span",{staticClass:"line-number"},[e._v("54")]),n("br"),n("span",{staticClass:"line-number"},[e._v("55")]),n("br"),n("span",{staticClass:"line-number"},[e._v("56")]),n("br"),n("span",{staticClass:"line-number"},[e._v("57")]),n("br"),n("span",{staticClass:"line-number"},[e._v("58")]),n("br"),n("span",{staticClass:"line-number"},[e._v("59")]),n("br"),n("span",{staticClass:"line-number"},[e._v("60")]),n("br"),n("span",{staticClass:"line-number"},[e._v("61")]),n("br"),n("span",{staticClass:"line-number"},[e._v("62")]),n("br"),n("span",{staticClass:"line-number"},[e._v("63")]),n("br"),n("span",{staticClass:"line-number"},[e._v("64")]),n("br"),n("span",{staticClass:"line-number"},[e._v("65")]),n("br"),n("span",{staticClass:"line-number"},[e._v("66")]),n("br"),n("span",{staticClass:"line-number"},[e._v("67")]),n("br"),n("span",{staticClass:"line-number"},[e._v("68")]),n("br"),n("span",{staticClass:"line-number"},[e._v("69")]),n("br"),n("span",{staticClass:"line-number"},[e._v("70")]),n("br"),n("span",{staticClass:"line-number"},[e._v("71")]),n("br"),n("span",{staticClass:"line-number"},[e._v("72")]),n("br"),n("span",{staticClass:"line-number"},[e._v("73")]),n("br"),n("span",{staticClass:"line-number"},[e._v("74")]),n("br"),n("span",{staticClass:"line-number"},[e._v("75")]),n("br"),n("span",{staticClass:"line-number"},[e._v("76")]),n("br"),n("span",{staticClass:"line-number"},[e._v("77")]),n("br"),n("span",{staticClass:"line-number"},[e._v("78")]),n("br"),n("span",{staticClass:"line-number"},[e._v("79")]),n("br"),n("span",{staticClass:"line-number"},[e._v("80")]),n("br"),n("span",{staticClass:"line-number"},[e._v("81")]),n("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);